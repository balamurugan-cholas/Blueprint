{% extends "base.html" %}

{% block title %}Dashboard | Blueprint{% endblock %}

{% block content %}
<style>
/* Preview Modal Styling */
#previewModal .modal-content, #deleteConfirmModal .modal-content { border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.15); padding:0; border:none; overflow:hidden; font-family:'Inter',sans-serif;}
#previewModal .modal-header, #deleteConfirmModal .modal-header { background-color:#f8f9fa; border-bottom:none; padding:1.25rem 1.5rem;}
#previewModal .modal-title, #deleteConfirmModal .modal-title { font-weight:700; font-size:1.5rem; color:#212529;}
#previewModal .btn-close, #deleteConfirmModal .btn-close { background:transparent; border:none; font-size:1.2rem;}
#previewModal .modal-body, #deleteConfirmModal .modal-body { padding:1.5rem; background-color:#fff; color:#495057;}
#previewModal h3#modalTitle { color:#0d6efd;}
#previewModal p, #deleteConfirmModal p { line-height:1.6; font-size:0.95rem;}
#previewModal h5 { font-size:1.05rem; font-weight:600; margin-bottom:0.5rem; color:#212529;}
#previewModal .modal-footer, #deleteConfirmModal .modal-footer { padding:1rem 1.5rem; background-color:#f8f9fa; border-top:none; display:flex; justify-content:flex-end; gap:0.5rem;}
#modalSteps { border-left:3px solid #0d6efd; padding-left:0.75rem; max-height:300px; overflow-y:auto; background-color:#f9f9f9; border-radius:6px;}
#modalSteps::-webkit-scrollbar { width:6px;}
#modalSteps::-webkit-scrollbar-thumb { background-color:rgba(13,110,253,0.4); border-radius:3px;}
#modalSteps::-webkit-scrollbar-track { background:transparent;}
.toast-notification { min-width:280px; max-width:350px; background-color:#0d6efd; color:#fff; padding:0.75rem 1.25rem; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.15); font-weight:500; opacity:0; transform:translateY(-20px); transition:all 0.4s ease-in-out;}
.toast-notification.show { opacity:1; transform:translateY(0);}
.project-card {
  display: flex;
  flex-direction: column;
  height: 155px; /* fixed height for all cards */
  padding: 1rem;
  box-sizing: border-box;
  overflow: hidden;
}

.project-card h6 {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  line-height: 1.2;
  display: -webkit-box;
  -webkit-line-clamp: 2; /* limit to 2 lines */
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
}

.project-card p {
  flex-grow: 1; /* takes remaining space */
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  color: #6c757d;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 4; /* limit description lines */
  -webkit-box-orient: vertical;
}

.project-card .result-actions, 
.project-card .d-flex.gap-2 {
  margin-top: auto; /* always keep buttons at the bottom */
  flex-shrink: 0;
}

</style>

<!-- Toast Container -->
<div id="toastContainer" style="position: fixed; top:1rem; left:50%; transform:translateX(-50%); z-index:2000; display:flex; flex-direction:column; gap:0.5rem;"></div>

<!-- Feature Cards -->
<div class="row g-4 mb-4">
  <div class="col-md-4">
    <div class="card p-3 text-center shadow-sm">
      <div class="mb-2"><i data-lucide="zap" class="icon-lg"></i></div>
      <h6 class="fw-bold">Fast</h6>
      <p class="text-muted small">Quick generation and response.</p>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 text-center shadow-sm">
      <div class="mb-2"><i data-lucide="shield-check" class="icon-lg"></i></div>
      <h6 class="fw-bold">Secure</h6>
      <p class="text-muted small">Built with modern security in mind.</p>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 text-center shadow-sm">
      <div class="mb-2"><i data-lucide="layers" class="icon-lg"></i></div>
      <h6 class="fw-bold">Clean</h6>
      <p class="text-muted small">Minimalistic and distraction-free design.</p>
    </div>
  </div>
</div>

<!-- Recent Projects -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="fw-bold">Recent Projects</h5>
</div>

<div class="row g-3" id="recent-projects">
  {% for project in recent_projects %}
  <div class="col-md-4 project-col" data-project-id="{{ project.id }}">
    <div style="height: 600px;" class="card project-card p-3 shadow-sm"
         data-description="{{ project.template.description }}"
         data-tech="{{ project.template.technologies }}"
         data-steps="{{ project.template.steps }}">
      <h6 class="fw-bold mb-1">{{ project.name }}</h6>
      <p class="small text-muted mb-2">Created: {{ project.created_at|date:"M d, Y | H:i A" }}</p>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-success btn-open"><i class="fa fa-folder-open"></i> Open</button>
        <button class="btn btn-sm btn-outline-danger btn-delete"><i class="fa fa-trash"></i> Delete</button>
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-muted small">No recent projects found.</p>
  {% endfor %}
</div>

<!-- All Projects -->
<div class="d-flex justify-content-between align-items-center mt-5 mb-3">
  <h5 class="fw-bold"><i data-lucide="folder" class="me-2"></i> All Projects</h5>
</div>

<div class="row g-3" id="projectsGrid">
  {% for project in all_projects %}
  <div class="col-md-4 project-col" data-project-id="{{ project.id }}">
    <div class="card project-card p-3 shadow-sm"
         data-description="{{ project.template.description }}"
         data-tech="{{ project.template.technologies }}"
         data-steps="{{ project.template.steps }}">
      <h6 class="fw-bold mb-1">{{ project.name }}</h6>
      <p class="small text-muted mb-2">Created: {{ project.created_at|date:"M d, Y | H:i A" }}</p>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-success btn-open"><i class="fa fa-folder-open"></i> Open</button>
        <button class="btn btn-sm btn-outline-danger btn-delete"><i class="fa fa-trash"></i> Delete</button>
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-muted small">No projects found.</p>
  {% endfor %}
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold fs-4">Project Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h3 id="modalTitle" class="fw-bold mb-3"></h3>
        <p class="text-muted small mb-3"><i data-lucide="calendar"></i> <span id="modalCreated"></span></p>
        <h5 class="fw-bold"><i data-lucide="file-text" class="me-1"></i> Description</h5>
        <p id="modalDescription" class="fw-semibold"></p>
        <h5 class="fw-bold"><i data-lucide="cpu" class="me-1"></i> Technologies</h5>
        <p id="modalTech" class="fw-semibold text-dark mb-0"></p>
        <h5 class="fw-bold"><i data-lucide="list-check" class="me-1"></i> Installation Steps</h5>
        <div id="modalSteps" class="fw-semibold text-dark" style="white-space: pre-line;"></div>
        <div class="alert alert-info small fw-semibold mt-3">
          <i data-lucide="info" class="me-2"></i> This template includes all installation steps and starter code.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmText">Are you sure you want to delete this project?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

  const toastContainer=document.getElementById("toastContainer");
  function showToast(msg){
    if(toastContainer.children.length>=2) toastContainer.removeChild(toastContainer.firstChild);
    const toast=document.createElement("div");
    toast.className="toast-notification"; toast.textContent=msg;
    toastContainer.appendChild(toast);
    setTimeout(()=>toast.classList.add("show"),10);
    setTimeout(()=>{ toast.classList.remove("show"); setTimeout(()=>toastContainer.removeChild(toast),400); },2000);
  }

  const previewModal=new bootstrap.Modal(document.getElementById("previewModal"));
  const deleteModal=new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
  let deleteTarget=null;

  // Open Project
  document.querySelectorAll(".btn-open").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const card=btn.closest(".project-card");
      document.getElementById("modalTitle").textContent=card.querySelector("h6").textContent;
      document.getElementById("modalDescription").textContent=card.dataset.description || "N/A";
      document.getElementById("modalCreated").textContent=card.querySelectorAll("p")[0]?.textContent || "";
      document.getElementById("modalTech").textContent=card.dataset.tech || "N/A";
      document.getElementById("modalSteps").textContent=card.dataset.steps || "N/A";
      previewModal.show();
    });
  });

  // Delete Project - show modal first
  document.querySelectorAll(".btn-delete").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      deleteTarget=btn.closest(".project-col");
      document.getElementById("deleteConfirmText").textContent=`Delete "${deleteTarget.querySelector("h6").textContent}"?`;
      deleteModal.show();
    });
  });

  document.getElementById("confirmDeleteBtn").addEventListener("click", ()=>{
    if(!deleteTarget) return;
    const projectId=deleteTarget.dataset.projectId;
    const projectName=deleteTarget.querySelector("h6").textContent;

    fetch("{% url 'delete_project' %}",{
      method:"POST",
      headers:{
        "Content-Type":"application/x-www-form-urlencoded",
        "X-CSRFToken":"{{ csrf_token }}"
      },
      body:new URLSearchParams({project_id:projectId})
    }).then(res=>res.json()).then(data=>{
      if(data.success){
        showToast(`Deleted "${projectName}"`);
        // Remove all instances of this project
        document.querySelectorAll(`.project-col[data-project-id="${projectId}"]`).forEach(c=>c.remove());
        // Auto-update recent projects
        updateRecentProjects();
      } else showToast("Error: "+data.error);
      deleteModal.hide();
      deleteTarget=null;
    }).catch(err=>console.error(err));
  });

  function updateRecentProjects(){
    const allProjects=document.querySelectorAll("#projectsGrid .project-col");
    const recentContainer=document.getElementById("recent-projects");
    recentContainer.innerHTML="";
    let count=0;
    for(const proj of allProjects){
      if(count>=3) break;
      recentContainer.appendChild(proj.cloneNode(true));
      count++;
    }
    // Re-attach event listeners
    recentContainer.querySelectorAll(".btn-open").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const card=btn.closest(".project-card");
        document.getElementById("modalTitle").textContent=card.querySelector("h6").textContent;
        document.getElementById("modalDescription").textContent=card.dataset.description || "N/A";
        document.getElementById("modalCreated").textContent=card.querySelectorAll("p")[0]?.textContent || "";
        document.getElementById("modalTech").textContent=card.dataset.tech || "N/A";
        document.getElementById("modalSteps").textContent=card.dataset.steps || "N/A";
        previewModal.show();
      });
    });
    recentContainer.querySelectorAll(".btn-delete").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        deleteTarget=btn.closest(".project-col");
        document.getElementById("deleteConfirmText").textContent=`Delete "${deleteTarget.querySelector("h6").textContent}"?`;
        deleteModal.show();
      });
    });
  }

  // Initialize recent projects
  updateRecentProjects();

});
</script>
{% endblock %}
